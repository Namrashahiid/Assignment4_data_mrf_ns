---
title: "Assignment4"
format: html
editor: visual
author: Marit Rygg Fredheim & Namra Shahid
---

## Assignment 4

```{r}
library(tidyverse)
library(lubridate)
library(PxWebApiData)
library(magrittr)

library(lubridate)
library(modelr)
library(broom)
library(lmtest)
library(sandwich)
library(viridis)
```

```{r}
load(file = "data/pm2.Rdata")
```

```{r}
pm2 %>%
mutate(
  # aar <- as.factor(2008:2017) ok
  # men neste er bedre
  aar_d = ymd(paste(aar, "-01-01", sep = "")),
  aar = parse_factor(aar),
  .before = pm2
)
```

```{r}
knr <- pm2 %>%
  select(knr) %>%
  distinct(knr) %>%
  pull()
```

```{r}
# dette holder hvis du vil se knr. 
knr |>
  print(width = 78)
pm2 %>% 
  select(knr) %>%
  distinct(knr) %>%
  pull()
```

```{r}
typeof(knr)
```

```{r}
pm2
```

### Sysselsatte

```{r}
metadata_13122 <- ApiData(
  "https://data.ssb.no/api/v0/no/table/13122/",
  returnMetaFrames = TRUE
)
```

```{r}
# Disse må vi angi for å hente data via API
names(metadata_13122)
```

```{r}
tid <- as.character(2008:2017)
```

```{r}
# Bruker ssb sin web-app og sjekker api-kall nederst på siden
# for å finne de argumentene som må settes. Ønsker sysselsatte
# utfra bosted for årene 2008:2017, for kommunene i knr, alle næringer,
# alle sektorer og ikke delt på kjønn
sysselsatte <- ApiData(
  urlToData = "13122",
  Region = knr,
  Alder = "20-66",
  NACE2007 = "00-99",
  Sektor = "ALLE",
  ContentsCode = "SysselEtterBoste",
  Tid = tid
    )

names(sysselsatte)[1] <- "desc"
names(sysselsatte)[2] <- "ss"
```

```{r}
# 
ss <- sysselsatte$ss %>% 
  # ...
  mutate(
    knavn = sysselsatte$desc$region,
  ) %>% 
  # Endrer variabelnavn
  rename(
    aar = Tid,
    knr = Region,
    ss = value 
  )  %>%
  select(aar, knavn, knr, ss) %>% 
  as_tibble()
```

```{r}
ss %>%
head(n = 5) %>%
print()
```

Gjør så tilsvarende for befolkning i alderen 20-66 år (tabell 07459).

```{r}
metadata_07459 <- ApiData(
```{r}
pm2 %<>%
  left_join(ss, by = c("aar", "knr"))
```

```{r}
ApiData(
  "https://data.ssb.no/api/v0/no/table/07459/",
  returnMetaFrames = TRUE
)
```

```{r}
names(metadata_07459)
```

Sjekker de ulike, Region og Tid vet vi hva skal være.

```{r}
# Kan prøve med Kjonn = FALSE og se om det gir total så
# slipper vi å addere menn og kvinner
metadata_07459$Kjonn
```

```{r}
# Slitsomt å hente alle år fra 20 til 66 og så aggregere selv
metadata_07459$Alder |>
  pull(values) |>
  print(width = 78)
```

```{r}
metadata_07459$ContentsCode
```

Ser fra API-spørring SSBs web-side at vi kan få alderskategorien vi ønsker vha.
"agg:Funksjonell2a,F309" som er gitt som hint i oppgaveteksten.

Hent ned befolkningsdata fra 07459, merge med ss og regn ut (sysselsatte_20_66/befolkning_20_66)\*100

```{r}

```

```{r}
#| echo: false
# siste
Alder = "20-66 år"
```

```{r}
tid <- as.character(2008:2017)
```

```{r}
befolkning <- ApiData(
  urlToData = "07459",
  Region = knr,
  Tid = tid,
  Alder = list("agg:Funksjonell2a", c("F309")),
  Kjonn = FALSE
    )

  names(befolkning)[1] <- "pop2066"
```

```{r}
bb <- befolkning$pop2066 %>% 
  # ...
  mutate(
    knavn = befolkning$pop2066$region,
    aar =  befolkning$dataset$Tid,
    knr = befolkning$dataset$Region
  ) %>% 
  # Endrer variabelnavn
  rename(
    befolkning = value) %>%
  select(knavn, aar, knr, alder, befolkning)
```

```{r}
pm2 %<>%
  left_join(bb, by = c("aar", "knr"))
  
```

```{r}
pm2 %<>%
  select(knr, aar, pm2, ya_p, inc_h, uni_p, nytt_bareal_pp, oms, tid, ss, alder, befolkning, knavn)
```

```{r}
#pm2 %>%
#summarise(ss, by = knr)
```

```{r}
pm2 %<>%
mutate(andel_ss = ss / befolkning * 100)
```

```{r}
pm2 %>%
select(aar, knr, andel_ss) %>%
head(n = 5) %>%
print()
```

Modell:

```{r}
pm2 <- pm2 %>%
  mutate(
    fnr = str_sub(knr, 1,2),
    aar_f = str_sub(aar)
  )
```

```{r}
pm2 %>%
  mutate(
    fnr = parse_factor(fnr, levels = fnr),
    aar_f = parse_factor(aar_f, levels = aar_f)
  )
```

```{r}
mod1 <- paste("pm2 ~ aar_f", "ya_p",
"inc_h", "uni_p",
"nytt_bareal_pp", "oms", "andel_ss", sep = " + ")
print(strwrap(mod1), quote = FALSE)
```

```{r}
lm1 <- lm(mod1, data = pm2)
```

14

```{r}
  summary(lm1)
```
